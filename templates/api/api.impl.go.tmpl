// Code generated by zen. DO NOT EDIT.
package api

import (
	"context"
	"{{ .ModuleName }}/api/gen"
	"{{ .ModuleName }}/common"
	"net/http"

	"github.com/labstack/echo/v4"
	"github.com/labstack/gommon/log"
)

{{- range $index, $resource := .Api.Resources}}
type {{ $resource.ModelRef | title | singularize }}Service interface {
	Get{{ $resource.ModelRef | title | singularize }}(
		ctx context.Context,
		{{- if eq $resource.Security "BearerAuth"}}
		user *common.AuthUser,
		{{- end }}
		id interface{},
	) (*gen.{{ $resource.ModelRef | title | singularize }}, error) 

	List{{ $resource.ModelRef | title }}(
		ctx context.Context,
		{{- if eq $resource.Security "BearerAuth"}}
		user *common.AuthUser,
		{{- end }}
		id interface{},
	) (*gen.{{ $resource.ModelRef | title }}, error) 

	Create{{ $resource.ModelRef | title | singularize }}(
		ctx context.Context,
		{{- if eq $resource.Security "BearerAuth"}}
		user *common.AuthUser,
		{{- end }}
		body *gen.{{ $resource.ModelRef | title | singularize }},
	) (*gen.{{ $resource.ModelRef | title | singularize}}, error) 

	Update{{ $resource.ModelRef | title | singularize }}(
		ctx context.Context,
		{{- if eq $resource.Security "BearerAuth"}}
		user *common.AuthUser,
		{{- end }}
		id interface{},
		body *gen.{{ $resource.ModelRef | title | singularize }},
	) (*gen.{{ $resource.ModelRef | title | singularize }}, error) 

	Delete{{ $resource.ModelRef | title | singularize }}(
		ctx context.Context,
		{{- if eq $resource.Security "BearerAuth"}}
		user *common.AuthUser,
		{{- end }}
		id interface{},
	) (*gen.{{ $resource.ModelRef | title | singularize }}, error) 
}
{{ end }}

type ApiService struct {
{{- range $index, $resource := .Api.Resources}}
	{{ $resource.ModelRef | title | singularize }}Service
{{- end }}
}

type ServerImpl struct {
	service ApiService
}

func NewServerImpl(
{{- range $index, $resource := .Api.Resources}}
	{{ $resource.ModelRef | untitle | singularize }}Service {{ $resource.ModelRef | title | singularize }}Service,
{{- end }}
) ServerImpl {
	return ServerImpl{
		service: ApiService{
{{- range $index, $resource := .Api.Resources}}
			{{ $resource.ModelRef | title | singularize }}Service: {{ $resource.ModelRef | untitle | singularize }}Service,
{{- end }}
		},
	}
}

{{ range $index, $resource := .Api.Resources }}

// {{ $resource.ModelRef | title }}
func (s *ServerImpl) Create{{ $resource.ModelRef | title | singularize }}(
	ctx echo.Context,
) error {
	{{- if eq .Security "BearerAuth" }}
	user := GetAuthUserFromContext(ctx)
	{{- end }}

	var body gen.{{ $resource.ModelRef | title | singularize }}
	err := ctx.Bind(&body)

	if err != nil {
		log.Error(err)
		return sendError(
			ctx, 
			http.StatusBadRequest, 
			10000, 
			"Invalid request body",
		)
	}

	resp, err := s.service.Create{{ $resource.ModelRef | title | singularize }}(
		ctx.Request().Context(),
		{{- if eq .Security "BearerAuth" }}
		user,
		{{- end }}
		&body,
	)

	if err != nil {
		log.Error(err)
		return sendError(
			ctx, 
			http.StatusInternalServerError, 
			10001, 
			"Failed to get{{ $resource.ModelRef | title | singularize }}",
		)
	}

	return ctx.JSON(201, resp)
}

func (s *ServerImpl) Get{{ $resource.ModelRef | title | singularize }}(
	ctx echo.Context,
	id interface{},
) error {
	{{- if eq .Security "BearerAuth" }}
	user := GetAuthUserFromContext(ctx)
	{{- end }}

	resp, err := s.service.Get{{ $resource.ModelRef | title | singularize }}(
		ctx.Request().Context(),
		{{- if eq .Security "BearerAuth" }}
		user,
		{{- end }}
		id,
	)

	if err != nil {
		log.Error(err)
		return sendError(
			ctx, 
			http.StatusInternalServerError, 
			10001, 
			"Failed to get{{ $resource.ModelRef | title | singularize }}",
		)
	}

	return ctx.JSON(200, resp)
}
{{- end}}

func sendError(
	ctx echo.Context, 
	statusCode int, 
	code int, 
	message string,
) error {
	resp := gen.Error{
		Code:    code,
		Message: message,
	}

	err := ctx.JSON(statusCode, resp)

	return err
}
